!function(e,t){"use strict";var r=e.antc,a=r.settings,c=r.utils,n=c.observer;r.ecommerce={scanItemprops:function(){return this.getItempropsData(["name","brand","description","category","image","url"])},getItempropsData:function(e){var t=this,r={};return[].forEach.call(e,function(e){r[e]=t.getItempropData()}),r},getItempropData:function(e){var r=t.querySelector("[itemprop="+e+"]");if(r)switch(r.nodeName){case"META":return r.content;case"A":return r.href;default:return c.dom.getText(r).trim()}},track:function(e,t,o){if(r.ecommerce.isTypeExists(e)){t=t||{};var i=c.object.is(t),s=c.array.is(t),l=i&&(!t||c.object.isEmpty(t)),f=s&&!t.length;if("detail"===e&&(l||f)){if(!a.ready.document){var u=n.subscribe("documentReady",function(){n.unsubscribe(u),r.ecommerce.track(e,t)});return}l=!(t=this.scanItemprops())||c.object.isEmpty(t)}if("seller"===e||!l&&!f){var b={};b.type=e,s?(b.a=[],[].forEach.call(t,function(e){try{e.category&&(e.category=r.ecommerce.prepareCategory(e.category)),b.a.push(JSON.stringify(e))}catch(e){}})):(b=c.object.assign(b,t)).category&&(b.category=r.ecommerce.prepareCategory(t.category)),b=c.object.assign(b,c.object.is(o)?o:{}),r.ecommerce.send(b)}}},prepareCategory:function(e){return e&&c.array.is(e)?c.array.flattenDeep(e).join("/"):e},isTypeExists:function(e){return-1!==["detail","add","remove","checkout","purchase","search","favourite","category","brand","seller"].indexOf(e)},send:function(e){var t=c.object.serialize(e),n=a.url.base+"api/rtb/ecommerce/";r.track.sendImg(n+(t.length?"?":"")+t),e&&"seller"===e.type&&(a.fb.enable||(a.fb.enable=!0),a.gtag.enable||(a.gtag.enable=!0),a.fb.seller.init||c.fb.init("seller"),a.gtag.seller.init||c.gtag.init("seller")),a.fb.enable&&r.ecommerce.sendFb(e)},sendFb:function(e){if("seller"!==e.type){var t=[];void 0===e.a?t=[e]:[].forEach.call(e.a,function(e){try{t.push(JSON.parse(e))}catch(e){}});var r={detail:"ViewContent",add:"AddToCart",checkout:"InitiateCheckout",purchase:"Purchase"};try{switch(e.type){case"search":[].forEach.call(t,function(e){c.fb.fbq("ozon","track","Search",{search_string:e.text})});break;case"category":[].forEach.call(t,function(e){c.fb.fbq("ozon","track","ViewContent",{content_type:"category",content_category:e.category,seller_id:e.seller_id})});break;case"brand":[].forEach.call(t,function(e){c.fb.fbq("ozon","track","ViewContent",{content_type:"brand",content_category:e.brand,seller_id:e.seller_id})});break;case"detail":case"add":case"checkout":case"purchase":[].forEach.call(t,function(t){c.fb.fbq("ozon","track",r[e.type],{content_category:t.category,content_name:t.name,content_ids:[t.id],currency:t.currency,value:t.price,seller_id:t.seller_id})});break;case"seller":[].forEach.call(t,function(e){c.fb.fbq("ozon","track","ViewContent",{content_category:"seller",content_type:"seller",seller_id:e.seller_id,content_ids:[e.seller_id]})})}}catch(e){}}}},a.fb.enable=-1!==e.location.host.indexOf("ozon.ru"),a.fb.enable&&(a.fb.ozon.init||c.fb.init("ozon")),r.module&&r.module.doneLoad("ecommerce")}(window,document);
